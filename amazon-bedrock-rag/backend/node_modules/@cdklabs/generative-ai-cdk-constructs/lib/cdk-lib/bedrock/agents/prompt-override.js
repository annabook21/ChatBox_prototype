"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PromptOverrideConfiguration = exports.AgentStepType = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const validation = require("../../../common/helpers/validation-helpers");
/**
 * The step in the agent sequence that this prompt configuration applies to.
 */
var AgentStepType;
(function (AgentStepType) {
    AgentStepType["PRE_PROCESSING"] = "PRE_PROCESSING";
    AgentStepType["ORCHESTRATION"] = "ORCHESTRATION";
    AgentStepType["POST_PROCESSING"] = "POST_PROCESSING";
    AgentStepType["ROUTING_CLASSIFIER"] = "ROUTING_CLASSIFIER";
    AgentStepType["MEMORY_SUMMARIZATION"] = "MEMORY_SUMMARIZATION";
    AgentStepType["KNOWLEDGE_BASE_RESPONSE_GENERATION"] = "KNOWLEDGE_BASE_RESPONSE_GENERATION";
})(AgentStepType || (exports.AgentStepType = AgentStepType = {}));
class PromptOverrideConfiguration {
    static fromSteps(steps) {
        // Create new object
        return new PromptOverrideConfiguration({ steps });
    }
    /**
     * Creates a PromptOverrideConfiguration with a custom Lambda parser function.
     * @param props Configuration including:
     *   - `parser`: Lambda function to use as custom parser
     *   - `steps`: prompt step configurations. At least one of the steps must make use of the custom parser.
     */
    static withCustomParser(props) {
        // Create new object
        return new PromptOverrideConfiguration(props);
    }
    /**
     * Create a new PromptOverrideConfiguration.
     *
     * @internal - This is marked as private so end users leverage it only through static methods
     */
    constructor(props) {
        this.validateInferenceConfig = (config) => {
            const errors = [];
            if (config) {
                if (config.temperature < 0 || config.temperature > 1) {
                    errors.push('Temperature must be between 0 and 1');
                }
                if (config.topP < 0 || config.topP > 1) {
                    errors.push('TopP must be between 0 and 1');
                }
                if (config.topK < 0 || config.topK > 500) {
                    errors.push('TopK must be between 0 and 500');
                }
                if (config.stopSequences.length > 4) {
                    errors.push('Maximum 4 stop sequences allowed');
                }
                if (config.maximumLength < 0 || config.maximumLength > 4096) {
                    errors.push('MaximumLength must be between 0 and 4096');
                }
            }
            return errors;
        };
        this.validateSteps = (steps) => {
            const errors = [];
            if (!steps || steps.length === 0) {
                errors.push('Steps array cannot be empty');
            }
            // Validate each step's inference config
            steps?.forEach(step => {
                const inferenceErrors = this.validateInferenceConfig(step.inferenceConfig);
                if (inferenceErrors.length > 0) {
                    errors.push(`Step ${step.stepType}: ${inferenceErrors.join(', ')}`);
                }
            });
            return errors;
        };
        this.validateCustomParser = (steps) => {
            const errors = [];
            const hasCustomParser = steps?.some(step => step.useCustomParser);
            if (!hasCustomParser) {
                errors.push('At least one step must use custom parser');
            }
            return errors;
        };
        // Validate props
        validation.throwIfInvalid(this.validateSteps, props.steps);
        if (props.parser) {
            validation.throwIfInvalid(this.validateCustomParser, props.steps);
        }
        this.parser = props.parser;
        this.steps = props.steps;
    }
    /**
     * Format as CfnAgent.PromptOverrideConfigurationProperty
     *
     * @internal This is an internal core function and should not be called directly.
     */
    _render() {
        return {
            overrideLambda: this.parser?.functionArn,
            promptConfigurations: this.steps?.map(step => ({
                // prettier-ignore
                promptType: step.stepType,
                /** Maps stepEnabled (true → 'ENABLED', false → 'DISABLED', undefined → undefined (uses CFN DEFAULT)) */
                promptState: step?.stepEnabled === undefined ? undefined : step.stepEnabled ? 'ENABLED' : 'DISABLED',
                /** Maps stepEnabled (true → 'OVERRIDDEN', false → 'DEFAULT', undefined → undefined (uses CFN DEFAULT)) */
                // prettier-ignore
                parserMode: step?.useCustomParser === undefined
                    ? undefined
                    : step?.useCustomParser ? 'OVERRIDDEN' : 'DEFAULT',
                // Use custom prompt template if provided, otherwise use default
                // prettier-ignore
                promptCreationMode: step?.customPromptTemplate === undefined
                    ? undefined
                    : step?.customPromptTemplate ? 'OVERRIDDEN' : 'DEFAULT',
                basePromptTemplate: step.customPromptTemplate,
                inferenceConfiguration: step.inferenceConfig,
            })) || [],
        };
    }
}
exports.PromptOverrideConfiguration = PromptOverrideConfiguration;
_a = JSII_RTTI_SYMBOL_1;
PromptOverrideConfiguration[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.PromptOverrideConfiguration", version: "0.1.296" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbXB0LW92ZXJyaWRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9hZ2VudHMvcHJvbXB0LW92ZXJyaWRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBZUEseUVBQXlFO0FBRXpFOztHQUVHO0FBQ0gsSUFBWSxhQU9YO0FBUEQsV0FBWSxhQUFhO0lBQ3ZCLGtEQUFpQyxDQUFBO0lBQ2pDLGdEQUErQixDQUFBO0lBQy9CLG9EQUFtQyxDQUFBO0lBQ25DLDBEQUF5QyxDQUFBO0lBQ3pDLDhEQUE2QyxDQUFBO0lBQzdDLDBGQUF5RSxDQUFBO0FBQzNFLENBQUMsRUFQVyxhQUFhLDZCQUFiLGFBQWEsUUFPeEI7QUFrSEQsTUFBYSwyQkFBMkI7SUFDL0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFpQztRQUN2RCxvQkFBb0I7UUFDcEIsT0FBTyxJQUFJLDJCQUEyQixDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsS0FBd0I7UUFDckQsb0JBQW9CO1FBQ3BCLE9BQU8sSUFBSSwyQkFBMkIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBd0JEOzs7O09BSUc7SUFDSCxZQUFvQixLQUF3QjtRQXlDcEMsNEJBQXVCLEdBQUcsQ0FBQyxNQUErQixFQUFZLEVBQUU7WUFDOUUsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO1lBRTVCLElBQUksTUFBTSxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7Z0JBQ3JELENBQUM7Z0JBQ0QsSUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxN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LFFBQVE7Z0JBQ3pCLHdHQUF3RztnQkFDeEcsV0FBVyxFQUFFLElBQUksRUFBRSxXQUFXLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsVUFBVTtnQkFDcEcsMEdBQTBHO2dCQUMxRyxrQkFBa0I7Z0JBQ2xCLFVBQVUsRUFDUixJQUFJLEVBQUUsZUFBZSxLQUFLLFNBQVM7b0JBQ2pDLENBQUMsQ0FBQyxTQUFTO29CQUNYLENBQUMsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLFNBQVM7Z0JBQ3RELGdFQUFnRTtnQkFDaEUsa0JBQWtCO2dCQUNsQixrQkFBa0IsRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEtBQUssU0FBUztvQkFDMUQsQ0FBQyxDQUFDLFNBQVM7b0JBQ1gsQ0FBQyxDQUFDLElBQUksRUFBRSxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTO2dCQUN6RCxrQkFBa0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CO2dCQUM3QyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsZUFBZTthQUM3QyxDQUFDLENBQUMsSUFBSSxFQUFFO1NBQ1osQ0FBQztJQUNKLENBQUM7O0FBbEZILGtFQXdJQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENmbkFnZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWJlZHJvY2snO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyB2YWxpZGF0aW9uIGZyb20gJy4uLy4uLy4uL2NvbW1vbi9oZWxwZXJzL3ZhbGlkYXRpb24taGVscGVycyc7XG5cbi8qKlxuICogVGhlIHN0ZXAgaW4gdGhlIGFnZW50IHNlcXVlbmNlIHRoYXQgdGhpcyBwcm9tcHQgY29uZmlndXJhdGlvbiBhcHBsaWVzIHRvLlxuICovXG5leHBvcnQgZW51bSBBZ2VudFN0ZXBUeXBlIHtcbiAgUFJFX1BST0NFU1NJTkcgPSAnUFJFX1BST0NFU1NJTkcnLFxuICBPUkNIRVNUUkFUSU9OID0gJ09SQ0hFU1RSQVRJT04nLFxuICBQT1NUX1BST0NFU1NJTkcgPSAnUE9TVF9QUk9DRVNTSU5HJyxcbiAgUk9VVElOR19DTEFTU0lGSUVSID0gJ1JPVVRJTkdfQ0xBU1NJRklFUicsXG4gIE1FTU9SWV9TVU1NQVJJWkFUSU9OID0gJ01FTU9SWV9TVU1NQVJJWkFUSU9OJyxcbiAgS05PV0xFREdFX0JBU0VfUkVTUE9OU0VfR0VORVJBVElPTiA9ICdLTk9XTEVER0VfQkFTRV9SRVNQT05TRV9HRU5FUkFUSU9OJyxcbn1cblxuLyoqXG4gKiBMTE0gaW5mZXJlbmNlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbmZlcmVuY2VDb25maWd1cmF0aW9uIHtcbiAgLyoqXG4gICAqIFRoZSBsaWtlbGlob29kIG9mIHRoZSBtb2RlbCBzZWxlY3RpbmcgaGlnaGVyLXByb2JhYmlsaXR5IG9wdGlvbnMgd2hpbGVcbiAgICogZ2VuZXJhdGluZyBhIHJlc3BvbnNlLiBBIGxvd2VyIHZhbHVlIG1ha2VzIHRoZSBtb2RlbCBtb3JlIGxpa2VseSB0byBjaG9vc2VcbiAgICogaGlnaGVyLXByb2JhYmlsaXR5IG9wdGlvbnMsIHdoaWxlIGEgaGlnaGVyIHZhbHVlIG1ha2VzIHRoZSBtb2RlbCBtb3JlXG4gICAqIGxpa2VseSB0byBjaG9vc2UgbG93ZXItcHJvYmFiaWxpdHkgb3B0aW9ucy5cbiAgICpcbiAgICogRmxvYXRpbmcgcG9pbnRcbiAgICpcbiAgICogbWluIDBcbiAgICogbWF4IDFcbiAgICovXG4gIHJlYWRvbmx5IHRlbXBlcmF0dXJlOiBudW1iZXI7XG4gIC8qKlxuICAgKiBXaGlsZSBnZW5lcmF0aW5nIGEgcmVzcG9uc2UsIHRoZSBtb2RlbCBkZXRlcm1pbmVzIHRoZSBwcm9iYWJpbGl0eSBvZiB0aGVcbiAgICogZm9sbG93aW5nIHRva2VuIGF0IGVhY2ggcG9pbnQgb2YgZ2VuZXJhdGlvbi4gVGhlIHZhbHVlIHRoYXQgeW91IHNldCBmb3JcbiAgICogVG9wIFAgZGV0ZXJtaW5lcyB0aGUgbnVtYmVyIG9mIG1vc3QtbGlrZWx5IGNhbmRpZGF0ZXMgZnJvbSB3aGljaCB0aGUgbW9kZWxcbiAgICogY2hvb3NlcyB0aGUgbmV4dCB0b2tlbiBpbiB0aGUgc2VxdWVuY2UuIEZvciBleGFtcGxlLCBpZiB5b3Ugc2V0IHRvcFAgdG9cbiAgICogODAsIHRoZSBtb2RlbCBvbmx5IHNlbGVjdHMgdGhlIG5leHQgdG9rZW4gZnJvbSB0aGUgdG9wIDgwJSBvZiB0aGVcbiAgICogcHJvYmFiaWxpdHkgZGlzdHJpYnV0aW9uIG9mIG5leHQgdG9rZW5zLlxuICAgKlxuICAgKiBGbG9hdGluZyBwb2ludFxuICAgKlxuICAgKiBtaW4gMFxuICAgKiBtYXggMVxuICAgKi9cbiAgcmVhZG9ubHkgdG9wUDogbnVtYmVyO1xuICAvKipcbiAgICogV2hpbGUgZ2VuZXJhdGluZyBhIHJlc3BvbnNlLCB0aGUgbW9kZWwgZGV0ZXJtaW5lcyB0aGUgcHJvYmFiaWxpdHkgb2YgdGhlXG4gICAqIGZvbGxvd2luZyB0b2tlbiBhdCBlYWNoIHBvaW50IG9mIGdlbmVyYXRpb24uIFRoZSB2YWx1ZSB0aGF0IHlvdSBzZXQgZm9yXG4gICAqIHRvcEsgaXMgdGhlIG51bWJlciBvZiBtb3N0LWxpa2VseSBjYW5kaWRhdGVzIGZyb20gd2hpY2ggdGhlIG1vZGVsIGNob29zZXNcbiAgICogdGhlIG5leHQgdG9rZW4gaW4gdGhlIHNlcXVlbmNlLiBGb3IgZXhhbXBsZSwgaWYgeW91IHNldCB0b3BLIHRvIDUwLCB0aGVcbiAgICogbW9kZWwgc2VsZWN0cyB0aGUgbmV4dCB0b2tlbiBmcm9tIGFtb25nIHRoZSB0b3AgNTAgbW9zdCBsaWtlbHkgY2hvaWNlcy5cbiAgICpcbiAgICogSW50ZWdlclxuICAgKlxuICAgKiBtaW4gMFxuICAgKiBtYXggNTAwXG4gICAqL1xuICByZWFkb25seSB0b3BLOiBudW1iZXI7XG4gIC8qKlxuICAgKiBBIGxpc3Qgb2Ygc3RvcCBzZXF1ZW5jZXMuIEEgc3RvcCBzZXF1ZW5jZSBpcyBhIHNlcXVlbmNlIG9mIGNoYXJhY3RlcnMgdGhhdFxuICAgKiBjYXVzZXMgdGhlIG1vZGVsIHRvIHN0b3AgZ2VuZXJhdGluZyB0aGUgcmVzcG9uc2UuXG4gICAqXG4gICAqIGxlbmd0aCAwLTRcbiAgICovXG4gIHJlYWRvbmx5IHN0b3BTZXF1ZW5jZXM6IHN0cmluZ1tdO1xuICAvKipcbiAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIHRva2VucyB0byBnZW5lcmF0ZSBpbiB0aGUgcmVzcG9uc2UuXG4gICAqXG4gICAqIEludGVnZXJcbiAgICpcbiAgICogbWluIDBcbiAgICogbWF4IDQwOTZcbiAgICovXG4gIHJlYWRvbmx5IG1heGltdW1MZW5ndGg6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDb250YWlucyBjb25maWd1cmF0aW9ucyB0byBvdmVycmlkZSBhIHByb21wdCB0ZW1wbGF0ZSBpbiBvbmUgcGFydCBvZiBhbiBhZ2VudCBzZXF1ZW5jZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbiB7XG4gIC8qKlxuICAgKiBUaGUgc3RlcCBpbiB0aGUgYWdlbnQgc2VxdWVuY2Ugd2hlcmUgdG8gc2V0IGEgc3BlY2lmaWMgcHJvbXB0IGNvbmZpZ3VyYXRpb24uXG4gICAqL1xuICByZWFkb25seSBzdGVwVHlwZTogQWdlbnRTdGVwVHlwZTtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZW5hYmxlIG9yIHNraXAgdGhpcyBzdGVwIGluIHRoZSBhZ2VudCBzZXF1ZW5jZS5cbiAgICogQGRlZmF1bHQgLSBUaGUgZGVmYXVsdCBzdGF0ZSBmb3IgZWFjaCBzdGVwIHR5cGUgaXMgYXMgZm9sbG93cy5cbiAgICpcbiAgICogICAgIFBSRV9QUk9DRVNTSU5HIOKAkyBFTkFCTEVEXG4gICAqICAgICBPUkNIRVNUUkFUSU9OIOKAkyBFTkFCTEVEXG4gICAqICAgICBLTk9XTEVER0VfQkFTRV9SRVNQT05TRV9HRU5FUkFUSU9OIOKAkyBFTkFCTEVEXG4gICAqICAgICBQT1NUX1BST0NFU1NJTkcg4oCTIERJU0FCTEVEXG4gICAqL1xuICByZWFkb25seSBzdGVwRW5hYmxlZD86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBUaGUgY3VzdG9tIHByb21wdCB0ZW1wbGF0ZSB0byBiZSB1c2VkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIFRoZSBkZWZhdWx0IHByb21wdCB0ZW1wbGF0ZSB3aWxsIGJlIHVzZWQuXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2JlZHJvY2svbGF0ZXN0L3VzZXJndWlkZS9wcm9tcHQtcGxhY2Vob2xkZXJzLmh0bWxcbiAgICovXG4gIHJlYWRvbmx5IGN1c3RvbVByb21wdFRlbXBsYXRlPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGluZmVyZW5jZSBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgdG8gdXNlLlxuICAgKi9cbiAgcmVhZG9ubHkgaW5mZXJlbmNlQ29uZmlnPzogSW5mZXJlbmNlQ29uZmlndXJhdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm9tcHRTdGVwQ29uZmlndXJhdGlvbkN1c3RvbVBhcnNlciBleHRlbmRzIFByb21wdFN0ZXBDb25maWd1cmF0aW9uIHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHRoZSBjdXN0b20gTGFtYmRhIHBhcnNlciBkZWZpbmVkIGZvciB0aGUgc2VxdWVuY2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHVzZUN1c3RvbVBhcnNlcj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tUGFyc2VyUHJvcHMge1xuICAvKlxuICAgKiBMYW1iZGEgZnVuY3Rpb24gdG8gdXNlIGFzIGN1c3RvbSBwYXJzZXJcbiAgICovXG4gIHJlYWRvbmx5IHBhcnNlcj86IElGdW5jdGlvbjtcbiAgLypcbiAgICogcHJvbXB0IHN0ZXAgY29uZmlndXJhdGlvbnMuIEF0IGxlYXN0IG9uZSBvZiB0aGUgc3RlcHMgbXVzdCBtYWtlIHVzZSBvZiB0aGUgY3VzdG9tIHBhcnNlci5cbiAgICovXG4gIHJlYWRvbmx5IHN0ZXBzPzogUHJvbXB0U3RlcENvbmZpZ3VyYXRpb25DdXN0b21QYXJzZXJbXTtcbn1cblxuZXhwb3J0IGNsYXNzIFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbiB7XG4gIHB1YmxpYyBzdGF0aWMgZnJvbVN0ZXBzKHN0ZXBzPzogUHJvbXB0U3RlcENvbmZpZ3VyYXRpb25bXSk6IFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbiB7XG4gICAgLy8gQ3JlYXRlIG5ldyBvYmplY3RcbiAgICByZXR1cm4gbmV3IFByb21wdE92ZXJyaWRlQ29uZmlndXJhdGlvbih7IHN0ZXBzIH0pO1xuICB9XG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgUHJvbXB0T3ZlcnJpZGVDb25maWd1cmF0aW9uIHdpdGggYSBjdXN0b20gTGFtYmRhIHBhcnNlciBmdW5jdGlvbi5cbiAgICogQHBhcmFtIHByb3BzIENvbmZpZ3VyYXRpb24gaW5jbHVkaW5nOlxuICAgKiAgIC0gYHBhcnNlcmA6IExhbWJkYSBmdW5jdGlvbiB0byB1c2UgYXMgY3VzdG9tIHBhcnNlclxuICAgKiAgIC0gYHN0ZXBzYDogcHJvbXB0IHN0ZXAgY29uZmlndXJhdGlvbnMuIEF0IGxlYXN0IG9uZSBvZiB0aGUgc3RlcHMgbXVzdCBtYWtlIHVzZSBvZiB0aGUgY3VzdG9tIHBhcnNlci5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgd2l0aEN1c3RvbVBhcnNlcihwcm9wczogQ3VzdG9tUGFyc2VyUHJvcHMpOiBQcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb24ge1xuICAgIC8vIENyZWF0ZSBuZXcgb2JqZWN0XG4gICAgcmV0dXJuIG5ldyBQcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb24ocHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBjdXN0b20gTGFtYmRhIHBhcnNlciBmdW5jdGlvbiB0byB1c2UuXG4gICAqIFRoZSBMYW1iZGEgcGFyc2VyIHByb2Nlc3NlcyBhbmQgaW50ZXJwcmV0cyB0aGUgcmF3IGZvdW5kYXRpb24gbW9kZWwgb3V0cHV0LlxuICAgKiBJdCByZWNlaXZlcyBhbiBpbnB1dCBldmVudCB3aXRoOlxuICAgKiAtIG1lc3NhZ2VWZXJzaW9uOiBWZXJzaW9uIG9mIG1lc3NhZ2UgZm9ybWF0ICgxLjApXG4gICAqIC0gYWdlbnQ6IEluZm8gYWJvdXQgdGhlIGFnZW50IChuYW1lLCBpZCwgYWxpYXMsIHZlcnNpb24pXG4gICAqIC0gaW52b2tlTW9kZWxSYXdSZXNwb25zZTogUmF3IG1vZGVsIG91dHB1dCB0byBwYXJzZVxuICAgKiAtIHByb21wdFR5cGU6IFR5cGUgb2YgcHJvbXB0IGJlaW5nIHBhcnNlZFxuICAgKiAtIG92ZXJyaWRlVHlwZTogVHlwZSBvZiBvdmVycmlkZSAoT1VUUFVUX1BBUlNFUilcbiAgICpcbiAgICogVGhlIExhbWJkYSBtdXN0IHJldHVybiBhIHJlc3BvbnNlIHRoYXQgdGhlIGFnZW50IHVzZXMgZm9yIG5leHQgYWN0aW9ucy5cbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYmVkcm9jay9sYXRlc3QvdXNlcmd1aWRlL2xhbWJkYS1wYXJzZXIuaHRtbFxuICAgKi9cbiAgcmVhZG9ubHkgcGFyc2VyPzogSUZ1bmN0aW9uO1xuXG4gIC8qKlxuICAgKiBUaGUgcHJvbXB0IGNvbmZpZ3VyYXRpb25zIHRvIG92ZXJyaWRlIHRoZSBwcm9tcHQgdGVtcGxhdGVzIGluIHRoZSBhZ2VudCBzZXF1ZW5jZS5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBObyBwcm9tcHQgY29uZmlndXJhdGlvbiB3aWxsIGJlIG92ZXJyaWRkZW4uXG4gICAqL1xuICByZWFkb25seSBzdGVwcz86IFByb21wdFN0ZXBDb25maWd1cmF0aW9uQ3VzdG9tUGFyc2VyW107XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBQcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb24uXG4gICAqXG4gICAqIEBpbnRlcm5hbCAtIFRoaXMgaXMgbWFya2VkIGFzIHByaXZhdGUgc28gZW5kIHVzZXJzIGxldmVyYWdlIGl0IG9ubHkgdGhyb3VnaCBzdGF0aWMgbWV0aG9kc1xuICAgKi9cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm9wczogQ3VzdG9tUGFyc2VyUHJvcHMpIHtcbiAgICAvLyBWYWxpZGF0ZSBwcm9wc1xuICAgIHZhbGlkYXRpb24udGhyb3dJZkludmFsaWQodGhpcy52YWxpZGF0ZVN0ZXBzLCBwcm9wcy5zdGVwcyk7XG4gICAgaWYgKHByb3BzLnBhcnNlcikge1xuICAgICAgdmFsaWRhdGlvbi50aHJvd0lmSW52YWxpZCh0aGlzLnZhbGlkYXRlQ3VzdG9tUGFyc2VyLCBwcm9wcy5zdGVwcyk7XG4gICAgfVxuICAgIHRoaXMucGFyc2VyID0gcHJvcHMucGFyc2VyO1xuICAgIHRoaXMuc3RlcHMgPSBwcm9wcy5zdGVwcztcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JtYXQgYXMgQ2ZuQWdlbnQuUHJvbXB0T3ZlcnJpZGVDb25maWd1cmF0aW9uUHJvcGVydHlcbiAgICpcbiAgICogQGludGVybmFsIFRoaXMgaXMgYW4gaW50ZXJuYWwgY29yZSBmdW5jdGlvbiBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuXG4gICAqL1xuICBwdWJsaWMgX3JlbmRlcigpOiBDZm5BZ2VudC5Qcm9tcHRPdmVycmlkZUNvbmZpZ3VyYXRpb25Qcm9wZXJ0eSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG92ZXJyaWRlTGFtYmRhOiB0aGlzLnBhcnNlcj8uZnVuY3Rpb25Bcm4sXG4gICAgICBwcm9tcHRDb25maWd1cmF0aW9uczpcbiAgICAgICAgdGhpcy5zdGVwcz8ubWFwKHN0ZXAgPT4gKHtcbiAgICAgICAgICAvLyBwcmV0dGllci1pZ25vcmVcbiAgICAgICAgICBwcm9tcHRUeXBlOiBzdGVwLnN0ZXBUeXBlLFxuICAgICAgICAgIC8qKiBNYXBzIHN0ZXBFbmFibGVkICh0cnVlIOKGkiAnRU5BQkxFRCcsIGZhbHNlIOKGkiAnRElTQUJMRUQnLCB1bmRlZmluZWQg4oaSIHVuZGVmaW5lZCAodXNlcyBDRk4gREVGQVVMVCkpICovXG4gICAgICAgICAgcHJvbXB0U3RhdGU6IHN0ZXA/LnN0ZXBFbmFibGVkID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBzdGVwLnN0ZXBFbmFibGVkID8gJ0VOQUJMRUQnIDogJ0RJU0FCTEVEJyxcbiAgICAgICAgICAvKiogTWFwcyBzdGVwRW5hYmxlZCAodHJ1ZSDihpIgJ09WRVJSSURERU4nLCBmYWxzZSDihpIgJ0RFRkFVTFQnLCB1bmRlZmluZWQg4oaSIHVuZGVmaW5lZCAodXNlcyBDRk4gREVGQVVMVCkpICovXG4gICAgICAgICAgLy8gcHJldHRpZXItaWdub3JlXG4gICAgICAgICAgcGFyc2VyTW9kZTpcbiAgICAgICAgICAgIHN0ZXA/LnVzZUN1c3RvbVBhcnNlciA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgIDogc3RlcD8udXNlQ3VzdG9tUGFyc2VyID8gJ09WRVJSSURERU4nIDogJ0RFRkFVTFQnLFxuICAgICAgICAgIC8vIFVzZSBjdXN0b20gcHJvbXB0IHRlbXBsYXRlIGlmIHByb3ZpZGVkLCBvdGhlcndpc2UgdXNlIGRlZmF1bHRcbiAgICAgICAgICAvLyBwcmV0dGllci1pZ25vcmVcbiAgICAgICAgICBwcm9tcHRDcmVhdGlvbk1vZGU6IHN0ZXA/LmN1c3RvbVByb21wdFRlbXBsYXRlID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IHN0ZXA/LmN1c3RvbVByb21wdFRlbXBsYXRlID8gJ09WRVJSSURERU4nIDogJ0RFRkFVTFQnLFxuICAgICAgICAgIGJhc2VQcm9tcHRUZW1wbGF0ZTogc3RlcC5jdXN0b21Qcm9tcHRUZW1wbGF0ZSxcbiAgICAgICAgICBpbmZlcmVuY2VDb25maWd1cmF0aW9uOiBzdGVwLmluZmVyZW5jZUNvbmZpZyxcbiAgICAgICAgfSkpIHx8IFtdLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlSW5mZXJlbmNlQ29uZmlnID0gKGNvbmZpZz86IEluZmVyZW5jZUNvbmZpZ3VyYXRpb24pOiBzdHJpbmdbXSA9PiB7XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgaWYgKGNvbmZpZy50ZW1wZXJhdHVyZSA8IDAgfHwgY29uZmlnLnRlbXBlcmF0dXJlID4gMSkge1xuICAgICAgICBlcnJvcnMucHVzaCgnVGVtcGVyYXR1cmUgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEnKTtcbiAgICAgIH1cbiAgICAgIGlmIChjb25maWcudG9wUCA8IDAgfHwgY29uZmlnLnRvcFAgPiAxKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdUb3BQIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxJyk7XG4gICAgICB9XG4gICAgICBpZiAoY29uZmlnLnRvcEsgPCAwIHx8IGNvbmZpZy50b3BLID4gNTAwKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdUb3BLIG11c3QgYmUgYmV0d2VlbiAwIGFuZCA1MDAnKTtcbiAgICAgIH1cbiAgICAgIGlmIChjb25maWcuc3RvcFNlcXVlbmNlcy5sZW5ndGggPiA0KSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdNYXhpbXVtIDQgc3RvcCBzZXF1ZW5jZXMgYWxsb3dlZCcpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbmZpZy5tYXhpbXVtTGVuZ3RoIDwgMCB8fCBjb25maWcubWF4aW11bUxlbmd0aCA+IDQwOTYpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ01heGltdW1MZW5ndGggbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDQwOTYnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZXJyb3JzO1xuICB9O1xuXG4gIHByaXZhdGUgdmFsaWRhdGVTdGVwcyA9IChzdGVwcz86IFByb21wdFN0ZXBDb25maWd1cmF0aW9uW10pOiBzdHJpbmdbXSA9PiB7XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgaWYgKCFzdGVwcyB8fCBzdGVwcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGVycm9ycy5wdXNoKCdTdGVwcyBhcnJheSBjYW5ub3QgYmUgZW1wdHknKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBlYWNoIHN0ZXAncyBpbmZlcmVuY2UgY29uZmlnXG4gICAgc3RlcHM/LmZvckVhY2goc3RlcCA9PiB7XG4gICAgICBjb25zdCBpbmZlcmVuY2VFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSW5mZXJlbmNlQ29uZmlnKHN0ZXAuaW5mZXJlbmNlQ29uZmlnKTtcbiAgICAgIGlmIChpbmZlcmVuY2VFcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBlcnJvcnMucHVzaChgU3RlcCAke3N0ZXAuc3RlcFR5cGV9OiAke2luZmVyZW5jZUVycm9ycy5qb2luKCcsICcpfWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGVycm9ycztcbiAgfTtcblxuICBwcml2YXRlIHZhbGlkYXRlQ3VzdG9tUGFyc2VyID0gKHN0ZXBzPzogUHJvbXB0U3RlcENvbmZpZ3VyYXRpb25DdXN0b21QYXJzZXJbXSk6IHN0cmluZ1tdID0+IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBjb25zdCBoYXNDdXN0b21QYXJzZXIgPSBzdGVwcz8uc29tZShzdGVwID0+IHN0ZXAudXNlQ3VzdG9tUGFyc2VyKTtcbiAgICBpZiAoIWhhc0N1c3RvbVBhcnNlcikge1xuICAgICAgZXJyb3JzLnB1c2goJ0F0IGxlYXN0IG9uZSBzdGVwIG11c3QgdXNlIGN1c3RvbSBwYXJzZXInKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXJyb3JzO1xuICB9O1xufVxuIl19